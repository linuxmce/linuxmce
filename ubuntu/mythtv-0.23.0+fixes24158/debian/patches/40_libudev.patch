## Description: Use libudev instead of calling udevinfo 
## Origin/Author: Based on http://svn.mythtv.org/trac/attachment/ticket/6137/mythtv-libudev-1.patch
## Bug: https://bugs.launchpad.net/bugs/479509
## Notes: The Build Depends of libudev-dev can be removed, if this patch is dropped. 
--- a/configure
+++ b/configure
@@ -1291,6 +1291,7 @@
     ivtv
     joystick_menu
     libfftw3
+    libudev
     lirc
     mheg
     opengl_video
@@ -1776,6 +1777,7 @@
 enable ivtv
 enable lamemp3
 enable lirc
+enable libudev
 enable mheg
 enable opengl
 enable opengl_vsync
@@ -3422,6 +3424,11 @@
 disabled  zlib || check_lib   zlib.h      zlibVersion -lz   || disable  zlib
 disabled bzlib || check_lib2 bzlib.h BZ2_bzlibVersion -lbz2 || disable bzlib
 
+# Attempt to use libudev for mediamonitor
+if test $target_os = linux; then
+    check_lib2 libudev.h udev_new -ludev || disable libudev
+fi
+
 enabled ffmpeg_pthreads && enable pthreads
 
 # check for some common methods of building with pthread support
@@ -4563,6 +4570,10 @@
   echo "PERL_CONFIG_OPTS=$PERL_CONFIG_OPTS" >> $MYTH_CONFIG_MAK
 fi
 
+if enabled libudev; then
+  echo "CONFIG_LIBUDEV_LIBS=-ludev" >> $MYTH_CONFIG_MAK
+fi
+
 if test x"$CCONFIG" != x"" ; then
   echo "CCONFIG=$CCONFIG" >> $MYTH_CONFIG_MAK
   echo "#define MYTH_BUILD_CONFIG \"$CCONFIG\"" >>$TMPH
--- a/libs/libmyth/libmyth.pro
+++ b/libs/libmyth/libmyth.pro
@@ -79,6 +79,7 @@
 LIBS += -L../libavcodec          -lmythavcodec-$${LIBVERSION}
 LIBS += -L../libavutil           -lmythavutil-$${LIBVERSION}
 unix:LIBS += -ldl
+using_libudev:LIBS += $${CONFIG_LIBUDEV_LIBS}
 
 TARGETDEPS += ../libmythsamplerate/libmythsamplerate-$${MYTH_LIB_EXT}
 TARGETDEPS += ../libmythsoundtouch/libmythsoundtouch-$${MYTH_LIB_EXT}
--- a/libs/libmyth/mediamonitor-unix.cpp
+++ b/libs/libmyth/mediamonitor-unix.cpp
@@ -38,6 +38,15 @@
 #include "mythhdd.h"
 #include "mythverbose.h"
 
+// Linux headers
+#ifdef linux
+#if CONFIG_LIBUDEV == 1
+extern "C" {
+#include <libudev.h>
+}
+#endif
+#endif
+
 #ifndef MNTTYPE_ISO9660
 #ifdef linux
 #define MNTTYPE_ISO9660 "iso9660"
@@ -218,6 +227,27 @@
     ret.replace(QRegExp(".*/"), "/dev/");
 
 #ifdef linux
+#if CONFIG_LIBUDEV == 1
+    // Use libudev to determine the name
+    ret = "";
+    struct udev	*udev = udev_new();
+    if (udev != NULL)
+    {
+	struct udev_device *device =
+	    udev_device_new_from_syspath(udev, sysfs.toAscii().constData());
+	if (device != NULL)
+	{
+	    const char *name = udev_device_get_devnode(device);
+
+	    if (name != NULL)
+		ret = tr(name);
+
+	    udev_device_unref(device);
+	}
+	udev_unref(udev);
+    }
+#else	// CONFIG_LIBUDEV
+    // Use udevinfo to determine the name
     QProcess    *udevinfo = new QProcess();
     QTextStream  stream(udevinfo);
     QStringList  args;
@@ -262,6 +292,7 @@
         return ret;
 
     udevinfo->deleteLater();
+#endif	// CONFIG_LIBUDEV
 #endif // linux
 
     VERBOSE(VB_MEDIA, msg + "->'" + ret + "'");
