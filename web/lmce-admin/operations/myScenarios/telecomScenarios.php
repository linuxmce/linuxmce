<?php
function telecomScenarios($output,$dbADO) {
	// include language files
	include(APPROOT.'/languages/'.$GLOBALS['lang'].'/common.lang.php');
	include(APPROOT.'/languages/'.$GLOBALS['lang'].'/telecomScenarios.lang.php');
	
	/* @var $dbADO ADOConnection */
	/* @var $rs ADORecordSet */

	$action = isset($_REQUEST['action'])?cleanString($_REQUEST['action']):'form';
	$out='';
	$installationID = (int)@$_SESSION['installationID'];
	$arrayID=$GLOBALS['ArrayIDCommunicationScenarios'];
	$templateWizard=$GLOBALS['TelecomScenariosTemplate'];

	$deviceCategory=$GLOBALS['rootPhones'];
	getDeviceCategoryChildsArray($deviceCategory,$dbADO);
	$GLOBALS['childsDeviceCategoryArray']=cleanArray($GLOBALS['childsDeviceCategoryArray']);
	$GLOBALS['childsDeviceCategoryArray'][]=$deviceCategory;

	$queryDeviceTemplate='
			SELECT * FROM DeviceTemplate 
				WHERE FK_DeviceCategory IN ('.join(',',$GLOBALS['childsDeviceCategoryArray']).')
			ORDER BY Description ASC';
	$resDeviceTemplate=$dbADO->Execute($queryDeviceTemplate);
	$phonesDTArray=array();
	while($rowDeviceCategory=$resDeviceTemplate->FetchRow()){
		$phonesDTArray[$rowDeviceCategory['PK_DeviceTemplate']]=$rowDeviceCategory['Description'];
	}

	if(isset($_REQUEST['cgID']) && (int)$_REQUEST['cgID']!=0){
		$canModifyInstallation = getUserCanModifyInstallation($_SESSION['userID'],$installationID,$dbADO);
	
		if (!$canModifyInstallation) {
			header("Location: index.php?section=telecomScenarios&error=$TEXT_NOT_AUTHORISED_TO_MODIFY_INSTALLATION_CONST");
			exit();
		}

		$delCG_ID=(int)$_REQUEST['cgID'];
		deleteCommandGroup($delCG_ID,$dbADO);
		setOrbitersNeedConfigure($installationID,$dbADO);
		header("Location: index.php?section=telecomScenarios&msg=$TEXT_THE_SPEED_DIAL_WAS_DELETED_CONST");
		exit();
	}

	if($action=='form') {

		$out.=setLeftMenu($dbADO);

		$out.='
	<div align="center" class="confirm"><B>'.@$_REQUEST['msg'].'</B></div>	
	<form action="index.php" method="POST" name="telecomScenarios">
		<input type="hidden" name="section" value="telecomScenarios">
		<input type="hidden" name="action" value="add">	
		<input type="hidden" name="roomID" value="">	
		<input type="hidden" name="roomName" value="">	
		
	<table width="100%" cellpadding="4" cellspacing="0" border="0">';
		$queryUsers='
		SELECT * FROM Users
			INNER JOIN Installation_Users ON FK_Users=PK_Users
		WHERE FK_Installation=? ORDER BY Users.UserName ASC';
		$resUsers=$dbADO->Execute($queryUsers,$installationID);
		$usersArray=array();
		while($rowUsers=$resUsers->FetchRow()){
			$usersArray[$rowUsers['PK_Users']]=$rowUsers['UserName'];
		}

		$queryRooms='
		SELECT Room.*, Room.Description AS RoomName FROM Room
		WHERE FK_Installation=?
			ORDER BY Room.Description ASC';
		$resRooms=$dbADO->Execute($queryRooms,$installationID);
		if($resRooms->RecordCount()==0){
			$out.=$TEXT_TS_NO_ROOMS_CONST;
		}
		$displayedRooms=array();
		$displayedRoomNames=array();
		$oldTelecomScenarios=array();
		$displayedSpeedDial=array();

		while($rowRooms=$resRooms->FetchRow()){
			$displayedRooms[]=$rowRooms['PK_Room'];
			$displayedRoomNames[]=$rowRooms['RoomName'];
			$queryCG='
				SELECT PK_CommandGroup,Description FROM CommandGroup
					INNER JOIN CommandGroup_Room on CommandGroup_Room.FK_CommandGroup=PK_CommandGroup
				WHERE FK_Room=? AND FK_Template=? AND AutoGeneratedDate=0';
			$resCG=$dbADO->Execute($queryCG,array($rowRooms['PK_Room'],$GLOBALS['TelecomScenariosTemplate']));

			$out.='
		<tr bgcolor="#D1D9EA">
			<td align="right" width="20">&nbsp;</td>
			<td><B>'.$rowRooms['RoomName'].'</B></td>
			<td align="center"><input type="button" class="button" name="addSpeedDial" value="'.$TEXT_ADD_SPEED_DIAL_CONST.'" onClick="self.location=\'index.php?section=telecomScenarios&action=addSpeedDial&roomID='.$rowRooms['PK_Room'].'&roomName='.urlencode($rowRooms['RoomName']).'\'"></td>
		</tr>
		<tr>
			<td colspan="3">'.autogeneratedScenarios($arrayID,0,$dbADO,2,'telecomScenarios',$rowRooms['PK_Room']).'</td>
		</tr>			
		<tr>
			<td align="right" width="20">&nbsp;</td>
			<td>
			<table>
				<tr>
					<td colspan="3"><B>'.$TEXT_SPEED_DIAL_CONST.'</B></td>
				</tr>
				<tr class="tablehead">
					<td align="center"><B>'.$TEXT_DESCRIPTION_CONST.'</B></td>
					<td align="center"><B>'.$TEXT_NUMBER_CONST.'</B></td>
					<td align="center"><B>'.$TEXT_PHONE_CONST.'</B></td>
					<td align="center"><B>'.$TEXT_ACTION_CONST.'</B></td>
				</tr>';

			if($resCG->RecordCount()==0){
				$out.='
				<tr>
					<td align="center" colspan="4">'.$TEXT_NO_SPEED_DIAL_CONST.'</td>
				</tr>';
			}
			while($rowSpeedDial=$resCG->FetchRow()){
				$displayedSpeedDial[]=$rowSpeedDial['PK_CommandGroup'];
				$queryNumber='
					SELECT * FROM CommandGroup_Command_CommandParameter
						INNER JOIN CommandGroup_Command ON FK_CommandGroup_Command=PK_CommandGroup_Command
						INNER JOIN CommandGroup ON CommandGroup_Command.FK_CommandGroup=PK_CommandGroup
					WHERE PK_CommandGroup=? AND FK_CommandParameter=?';
				$resNumber=$dbADO->Execute($queryNumber,array($rowSpeedDial['PK_CommandGroup'],$GLOBALS['commandPhoneExtension']));
				$rowNumber=$resNumber->FetchRow();
				
				$querySelDevice='
					SELECT * FROM CommandGroup_Command_CommandParameter
						INNER JOIN CommandGroup_Command ON FK_CommandGroup_Command=PK_CommandGroup_Command
						INNER JOIN CommandGroup ON CommandGroup_Command.FK_CommandGroup=PK_CommandGroup
					WHERE PK_CommandGroup=? AND FK_CommandParameter=?';
				$resSelDevice=$dbADO->Execute($querySelDevice,array($rowSpeedDial['PK_CommandGroup'],$GLOBALS['commandParamPK_DeviceTo']));
				$rowSelDevice=$resSelDevice->FetchRow();
				$out.='
				<tr bgColor="#F0F3F8">
					<td align="center"><textarea name="description_'.$rowSpeedDial['PK_CommandGroup'].'">'.$rowSpeedDial['Description'].'</textarea></td>
					<td align="center"><input type="text" name="number_'.$rowSpeedDial['PK_CommandGroup'].'" value="'.$rowNumber['IK_CommandParameter'].'"></td>
					<td align="center">';
				if(count($phonesDTArray)==0)
					$phonesDTArray[]=0;
				$queryDevice='
					SELECT Device.*,Room.Description AS Room
					FROM Device 
					LEFT JOIN Room ON FK_Room=PK_Room
					WHERE
						FK_DeviceTemplate IN ('.join(',',array_keys($phonesDTArray)).') AND Device.FK_Installation=?';	
				$resDevice=$dbADO->Execute($queryDevice,$installationID);
				$out.='<select name="phone_'.$rowSpeedDial['PK_CommandGroup'].'">
						<option value="0">'.$TEXT_PLEASE_SELECT_CONST.'</option>';
				while($rowDevice=$resDevice->FetchRow()){
					$out.='<option value="'.$rowDevice['PK_Device'].'" '.(($rowDevice['PK_Device']==$rowSelDevice['IK_CommandParameter'])?'selected':'').'>'.$rowDevice['Description'].' ['.$rowDevice['Room'].']</option>';
				}
				$out.='
				</select>';
				$out.='
					</td>
					<td><a href="#" onClick="if(confirm(\''.$TEXT_CONFIRM_DELETE_SPEED_DIAL_CONST.'\'))self.location=\'index.php?section=telecomScenarios&cgID='.$rowSpeedDial['PK_CommandGroup'].'\'">'.$TEXT_DELETE_CONST.'</a></td>
				</tr>';
			}
			if($resCG->RecordCount()>0){
				$out.='
				<tr>
					<td align="center" colspan="4"><input type="submit" class="button" name="update" value="'.$TEXT_UPDATE_SPEED_DIAL_CONST.'"> <input type="reset" class="button" name="cancelBtn" value="'.$TEXT_CANCEL_CONST.'"></td>
				</tr>';
			}
			$out.='
			</table>
			</td>
			<td>&nbsp;</td>
		</tr>';
		}
		$out.='
		</table>
		
		<input type="hidden" name="displayedSpeedDial" value="'.join(',',$displayedSpeedDial).'">
		<input type="hidden" name="displayedUsers" value="'.join(',',array_keys($usersArray)).'">
		<input type="hidden" name="displayedRooms" value="'.join(',',$displayedRooms).'">
		<input type="hidden" name="displayedRoomNames" value="'.join(',',$displayedRoomNames).'">
		<input type="hidden" name="oldTelecomScenarios" value="'.join(',',$oldTelecomScenarios).'">
	</form>
	';

	}elseif($action=='addSpeedDial'){
		$out.='
		<form action="index.php" method="POST" name="telecomScenarios">
			<input type="hidden" name="section" value="telecomScenarios">
			<input type="hidden" name="action" value="add">	
			<input type="hidden" name="roomID" value="'.$_REQUEST['roomID'].'">	
			<table align="center">
				<tr bgcolor="#D1D9EA">
					<td colspan="2" align="center"><B>'.$TEXT_ADD_SPEED_DIAL_CONST.'</B></td>
				</tr>
				<tr>
					<td>'.$TEXT_DESCRIPTION_CONST.' *</td>
					<td><textarea rows="2" name="description"></textarea></td>
				</tr>
				<tr>
					<td>'.$TEXT_NUMBER_CONST.' *</td>
					<td><input type="text" name="number" value=""></td>
				</tr>
				<tr>
					<td>'.$TEXT_PHONE_CONST.' *</td>
					<td>';
				if(count($phonesDTArray)==0)
					$phonesDTArray[]=0;
				$queryDevice='
					SELECT Device.*,Room.Description AS Room
					FROM Device 
					LEFT JOIN Room ON FK_Room=PK_Room
					WHERE
						FK_DeviceTemplate IN ('.join(',',array_keys($phonesDTArray)).') AND Device.FK_Installation=?';	
				$resDevice=$dbADO->Execute($queryDevice,$installationID);
				$out.='<select name="phone">
						<option value="0">'.$TEXT_PLEASE_SELECT_CONST.'</option>';
				while($rowDevice=$resDevice->FetchRow()){
					$out.='<option value="'.$rowDevice['PK_Device'].'">'.$rowDevice['Description'].' ['.$rowDevice['Room'].']</option>';
				}
				$out.='
				</select>';
				$out.='		
					</td>
				</tr>
				<tr>
					<td align="left" colspan="2"><em>* '.$TEXT_REQUIRED_FIELDS_CONST.'</em></td>
				</tr>
				<tr>
					<td align="center" colspan="2"><input type="submit" class="button" name="addSpeedDial" value="'.$TEXT_ADD_SPEED_DIAL_CONST.'"> <input type="reset" class="button" name="cancelBtn" value="'.$TEXT_CANCEL_CONST.'"></td>
				</tr>
			</table>
			<script>
		 		var frmvalidator = new formValidator("telecomScenarios");
 				frmvalidator.addValidation("description","req","'.$TEXT_TELECOM_SCENARIOS_DESCRIPTION_REQUIRED_CONST.'");			
				frmvalidator.addValidation("number","req","'.$TEXT_TELECOM_SCENARIOS_NUMBER_REQUIRED_CONST.'");			
				frmvalidator.addValidation("phone","dontselect=0","'.$TEXT_TELECOM_SCENARIOS_PHONE_REQUIRED_CONST.'");			
			</script>
				
		</form>
		';
	}else{
		// process area
		//check if current user canModifyInstallation
		$canModifyInstallation = getUserCanModifyInstallation($_SESSION['userID'],$installationID,$dbADO);
	
		if (!$canModifyInstallation) {
			header("Location: index.php?section=telecomScenarios&error=$TEXT_NOT_AUTHORISED_TO_MODIFY_INSTALLATION_CONST");
			exit();
		}
		
		if(isset($_POST['addSpeedDial'])){
			$description=$_POST['description'];
			$number=$_POST['number'];
			$phone=(isset($_POST['phone']) && $_POST['phone']!='0')?$_POST['phone']:NULL;
			$roomID=$_REQUEST['roomID'];
			$roomName=@$_REQUEST['roomName'];

			$cmd="sudo -u root /usr/pluto/bin/CreateSpeedDial.sh '$description' '$number' '$phone' '$roomID' '$roomName'";
			exec_batch_command($cmd);
			
			header("Location: index.php?section=telecomScenarios&msg=$TEXT_SPEED_DIAL_ADDED_CONST");
			exit();
		}

		if(isset($_POST['update']) || $action=='externalSubmit'){
			$displayedSpeedDialArray=explode(',',$_POST['displayedSpeedDial']);
			foreach($displayedSpeedDialArray AS $speedDial){
				$description=$_POST['description_'.$speedDial];
				$number=$_POST['number_'.$speedDial];
				$phone=(isset($_POST['phone_'.$speedDial]) && $_POST['phone_'.$speedDial]!='0')?$_POST['phone_'.$speedDial]:NULL;
				
				$updateCG='UPDATE CommandGroup SET Description=? WHERE PK_CommandGroup=?';
				$dbADO->Execute($updateCG,array($description,$speedDial));
				
				$queryNumberCGP='
					SELECT * FROM CommandGroup_Command_CommandParameter
						INNER JOIN CommandGroup_Command ON FK_CommandGroup_Command=PK_CommandGroup_Command
						INNER JOIN CommandGroup ON CommandGroup_Command.FK_CommandGroup=PK_CommandGroup
						INNER JOIN CommandGroup_Room ON CommandGroup_Room.FK_CommandGroup=PK_CommandGroup
					WHERE PK_CommandGroup=? AND FK_CommandParameter=?';
				$resNumber=$dbADO->Execute($queryNumberCGP,array($speedDial,$GLOBALS['commandPhoneExtension']));
				$rowNumber=$resNumber->FetchRow();
				$updateCGP='UPDATE CommandGroup_Command_CommandParameter SET IK_CommandParameter=? WHERE FK_CommandGroup_Command=? AND FK_CommandParameter=?';
				$dbADO->Execute($updateCGP,array($number,$rowNumber['FK_CommandGroup_Command'],$GLOBALS['commandPhoneExtension']));
				
				$querySelDevice='
					SELECT * FROM CommandGroup_Command_CommandParameter
						INNER JOIN CommandGroup_Command ON FK_CommandGroup_Command=PK_CommandGroup_Command
						INNER JOIN CommandGroup ON CommandGroup_Command.FK_CommandGroup=PK_CommandGroup
						INNER JOIN CommandGroup_Room ON CommandGroup_Room.FK_CommandGroup=PK_CommandGroup
					WHERE PK_CommandGroup=? AND FK_CommandParameter=?';
				$resSelDevice=$dbADO->Execute($querySelDevice,array($speedDial,$GLOBALS['commandParamPK_DeviceTo']));
				$rowSelDevice=$resSelDevice->FetchRow();
				$dbADO->Execute($updateCGP,array($phone,$rowSelDevice['FK_CommandGroup_Command'],$GLOBALS['commandParamPK_DeviceTo']));
			}
		}
		
		setOrbitersNeedConfigure($installationID,$dbADO);	
		header("Location: index.php?section=telecomScenarios&msg=$TEXT_TELECOM_SCENARIO_UPDATED_CONST");
	}

	$output->setMenuTitle($TEXT_WIZARD_CONST.' |');
	$output->setPageTitle($TEXT_TELECOM_SCENARIOS_CONST);
	$output->setNavigationMenu(array($TEXT_MY_SCENARIOS_CONST=>'index.php?section=myScenarios',$TEXT_TELECOM_SCENARIOS_CONST=>'index.php?section=telecomScenarios'));
	$output->setScriptCalendar('null');
	$output->setBody($out);
	$output->setTitle(APPLICATION_NAME.' :: '.$TEXT_TELECOM_SCENARIOS_CONST);
	$output->output();

}
?>
